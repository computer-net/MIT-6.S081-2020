# 介绍

实验一地址 [Lab: Xv6 and Unix utilities](https://pdos.csail.mit.edu/6.828/2020/labs/util.html)

# 实验内容

### 实验环境（Boot xv6）

Ubuntu 20.04

建议先看一下[xv6 book](https://pdos.csail.mit.edu/6.828/2020/xv6/book-riscv-rev1.pdf)的第一章，主要看一下 1.1-1.3。

### 任务一（sleep）

这是最简单的一个任务，直接调用提供的 sleep 方法即可，纯属为了好上手。

在写完代码后，需要在 Makefile 文件中的 UPROGS 字段中添加，然后才能使用 ./grade-lab-util 进行测试。 

### 任务二（pingpong）

使用 pipe() 和 fork() 实现父进程发送一个字符，子进程成功接收该字符后打印 received ping，再向父进程发送一个字符，父进程成功接收后打印 received pong。

-  **文件描述符**

这里需要懂得什么是文件描述符。在 Linux 操作系统中，一切皆文件，内核通过文件描述符访问文件。每个进程都会默认打开3个文件描述符,即0、1、2。其中0代表标准输入流（stdin）、1代表标准输出流（stdout）、2代表标准错误流（stderr）。

- **管道**

管道是操作系统进程间通信的一种方式，可以使用 pipe() 函数进行创建。有在管道创建后，就有两个文件描述符，一个是负责读，一个是负责写。两个描述符对应内核中的同一块内存，管道的主要特点：

1. 数据在管道中以字节流的形式传输，由于管道是半双工的，管道中的数据只能单向流动。

2. 管道只能用于具有亲缘关系的进程通信，父子进程或者兄弟进程。

3. 在 fork() 后，父进程和子进程拥有相同的管道描述符，通常为了安全起见，我们关闭一个进程的读描述符和另一个进程的写描述符，这样就可以让数据更安全地传输。

注：这里需要使用两个管道，我尝试改成一个，并没有成功...不太懂如何使用一个管道，感觉还是使用两个管道更加安全些。

### 任务三（primes）

任务是输出区间内的质数 [2, 35]，如果一般的方法，直接挨个遍历计算就行，但由于这里需要充分使用 pipe  和 fork 方法，因此需要一些不一样的方法。

下面使用的方法是埃拉托斯特尼素数筛，简称筛法。简单地说就是，每次得到一个素数时，在所有小于 n 的数中，删除它的倍数，然后不断迭代，剩下的就全是素数了。

实现思想是，只要还没获取到所有的素数，便不断遍历/递归。每次递归时：

1. 先在父进程中创建一个子进程。
2. 利用子进程将剩下的所有数全都写到管道中。
3. 在父进程中，将数不断读出来，管道中第一个数一定是素数，然后删除它的倍数（如果不是它的倍数，就继续更新数组，同时记录数组中目前已有的数字数量）。

无论是使用迭代的方式还是递归的方法，大致思想都是相同的。这道题我想了好久，。。

### 任务四（find）

在路径中查找特定文件名的文件。

基本直接复制 user/ls.c 文件内容。有几点需要注意的：

1. 在获取文件名的函数（fmtname）中，需要设置 buf[strlen(p)] = 0; 否则比较函数 strcmp 会失效。
2. memmove() 是 memcpy() 的改进版，实现的功能相同，但更安全，具体分析见[这篇博客](https://blog.csdn.net/wanna_wsl/article/details/70305814)，大致是说，一个是从头部开始复制，一个是从尾部开始复制。
3. 结构体 stat 和 dirent 分别存储文件的信息和目录的信息。没有很理解，留着以后再看。
4. 不太懂 de.inum 是干嘛的，有的代码还把它等于 1 的情况省略了，不懂为啥。

### 任务五（xargs）

没咋用过这个命令，还是先查的它是啥功能。主要作用是读取标准输出中的信息，然后将其作为标准输入，拼接到下一个命令后面来执行。神奇！

注意的一点是，利用 fork() 让命令在子进程中执行后，函数并没有结束，还需要继续读取，因此一些变量需要继续设置新的值。

命令中的 | 表示管道（我一直以为这是与或非的或，。。惭愧）。

# 总结

这个实验算是熟悉一下 xv6 的环境和操作吧，确实感觉学到了很多东西，大赞！

文章同步在[知乎](https://zhuanlan.zhihu.com/p/429412443)。

# 参考文章

  1. [Mit6.S081-实验1-Xv6 and Unix utilities](https://blog.csdn.net/u013577996/article/details/108680888)
 2. [操作系统实验Mit6.S801笔记 Lab1: Util](https://blog.csdn.net/weixin_46477226/article/details/119482886)
 3. [MIT-6.s081-OS lab util Unix utilities](https://www.programmersought.com/article/90476913175/)
 4. [【MIT-6.S081-2020】Lab1 Util](https://zhuanlan.zhihu.com/p/272199762)
